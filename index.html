<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Diagraming the Rock Cycle</title>
</head>

<body>

  <div class="fullpage">

  <div class="section">
  
      <a class="thmb" href="#" onclick="enableFreeDrawing()" style="padding: 0px 10px;margin:5px;border: 2px solid;">Draw</a>
 
      <a class="thmb" href="#" onclick="enableSelection()" style="padding: 0px 10px;margin:5px;border: 2px solid;">Select</a>

      <!-- <button id="delete-one">Delete</button> -->

      <button onClick="deleteObject()">Delete</button>

      <button id="clear-canvas" class="btn btn-info">Clear entire canvas</button>

      <a id="lnkDownload" href="#">Save image</a>
     
      <div class="canvas-container">
          <canvas id="canvas1" style="border: 1px solid;"></canvas>
      </div>
      
      <div class="furniture" style="padding: 20px;border: 1px solid;width: 1000px">
          <h3>Your challenge is to create a diagram of a possible route through the rock cycle for the materials shown below. Drag each material to the canvas above, show lines with arrowheads and then drag the appropriate term to describe the process that caused the transformation represented by the line.</h3> 
          <img crossOrigin="Anonymous" draggable="true" src="https://pbs.twimg.com/profile_images/493834338182516736/fUxEkyu8_400x400.png" width="60">
          
      </div>

  </div>

</div>

</body>
</html>


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

<script src='https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.22/fabric.min.js'></script>


<script>

function initCanvas() {
  $('.canvas-container').each(function(index) {

    var canvasContainer = $(this)[0];
    var canvasObject = $("canvas", this)[0];
    var clearEl = $('clear-canvas');

    var imageOffsetX, imageOffsetY;

    

    function handleDragStart(e) {
      [].forEach.call(images, function(img) {
        img.classList.remove('img_dragging');
      });
      this.classList.add('img_dragging');
      var imageOffset = $(this).offset();
      imageOffsetX = e.clientX - imageOffset.left;
      imageOffsetY = e.clientY - imageOffset.top;
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'copy';
      return false;
    }

    function handleDragEnter(e) {
      this.classList.add('over');
    }

    function handleDragLeave(e) {
      this.classList.remove('over');
    }

    function handleDrop(e) {
      e = e || window.event;
      if (e.preventDefault) {
        e.preventDefault();
      }
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      var img = document.querySelector('.furniture img.img_dragging');
      console.log('event: ', e);

      var offset = $(canvasObject).offset();
      var y = e.clientY - (offset.top + imageOffsetY);
      var x = e.clientX - (offset.left + imageOffsetX);

      var newImage = new fabric.Image(img, {
        width: img.width,
        height: img.height,
        left: x,
        top: y
      });
      canvas.add(newImage);
      return false;
    }

    function handleDragEnd(e) {
      [].forEach.call(images, function(img) {
        img.classList.remove('img_dragging');
      });
    }

    var images = document.querySelectorAll('.furniture img');
    [].forEach.call(images, function(img) {
      img.addEventListener('dragstart', handleDragStart, false);
      img.addEventListener('dragend', handleDragEnd, false);
    });
    canvasContainer.addEventListener('dragenter', handleDragEnter, false);
    canvasContainer.addEventListener('dragover', handleDragOver, false);
    canvasContainer.addEventListener('dragleave', handleDragLeave, false);
    canvasContainer.addEventListener('drop', handleDrop, false);
  });
}
initCanvas();

var canvas = new fabric.Canvas('canvas1', {
  selection: false
});

canvas.setHeight(500);
canvas.setWidth(1040);


var line, isDown;

function enableFreeDrawing(){
  removeEvents();
  canvas.isDrawingMode = true;
  canvas.freeDrawingBrush.color = "black";
  canvas.freeDrawingBrush.width = 5;
  canvas.renderAll();
}

function enableSelection() {
  removeEvents();
  changeObjectSelection(true);
  canvas.selection = true;
}

function changeObjectSelection(value) {
  canvas.forEachObject(function (obj) {
    obj.selectable = value;
  });
  canvas.renderAll();
}

function removeEvents() {
  canvas.isDrawingMode = false;
  canvas.selection = false;
  canvas.off('mouse:down');
  canvas.off('mouse:up');
  canvas.off('mouse:move');
}

$('#clear-canvas').on('click', function() {
  canvas.clear();
  //alert('Cleared');
});

$('#cdelete-one').on('click', function() {
  canvas.clear();
  //alert('Cleared');
});

window.deleteObject = function () {
    canvas.getActiveObject().remove();
}


function handleImage(e) {
    var objects = canvas.getObjects();
    for (var i in objects) {
       objects[i].remove();
    }
    var reader = new FileReader();
    reader.onload = function (event) {
        var img = new Image();
        img.onload = function () {
            var imgInstance = new fabric.Image(img, {
               selectable: 1
            })
            canvas.add(imgInstance);
            canvas.deactivateAll().renderAll();
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
}


var imageSaver = document.getElementById('lnkDownload');
imageSaver.addEventListener('click', saveImage, false);

function saveImage(e) {
    this.href = canvas.toDataURL({
        format: 'png',
        quality: 0.8
    });
    this.download = 'canvas.png'
}

</script>